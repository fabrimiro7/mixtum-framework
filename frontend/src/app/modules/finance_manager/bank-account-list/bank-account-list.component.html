<div class="container-fluid">
  <!-- Header -->
  <div class="row align-items-center mb-4">
    <div class="col">
      <h1>Banche e Conti</h1>
    </div>
    <div class="col-md-auto">
      <button mat-raised-button class="primary-button-light me-2" (click)="navigateTo('/finance')">
        <mat-icon fontIcon="arrow_back"></mat-icon>
        <span>MOVIMENTI</span>
      </button>
      <button mat-raised-button class="primary-button me-2" *ngIf="activeTab === 'accounts'" (click)="addAccount()">
        <mat-icon fontIcon="add"></mat-icon>
        <span>NUOVO CONTO</span>
      </button>
      <button mat-raised-button class="primary-button" *ngIf="activeTab === 'banks'" (click)="addBank()">
        <mat-icon fontIcon="add"></mat-icon>
        <span>NUOVA BANCA</span>
      </button>
    </div>
  </div>

  <!-- Total Balance Card -->
  <div class="balance-card mb-4" *ngIf="aggregateBalance">
    <div class="balance-content">
      <span class="balance-label">Saldo Totale</span>
      <span class="balance-value" [ngClass]="getTotalBalance() >= 0 ? 'positive' : 'negative'">
        {{ formatCurrency(getTotalBalance()) }}
      </span>
      <span class="balance-accounts">{{ aggregateBalance.accounts_count }} conti attivi</span>
    </div>
  </div>

  <!-- Tabs -->
  <div class="ed-block-standard mb-4">
    <div class="tabs-header">
      <button mat-button [class.active]="activeTab === 'accounts'" (click)="setTab('accounts')">
        <mat-icon>account_balance_wallet</mat-icon>
        Conti ({{ accounts.length }})
      </button>
      <button mat-button [class.active]="activeTab === 'banks'" (click)="setTab('banks')">
        <mat-icon>account_balance</mat-icon>
        Banche ({{ banks.length }})
      </button>
      <div class="spacer"></div>
      <mat-slide-toggle [(ngModel)]="showInactive" (change)="onFilterChange()">
        Mostra inattivi
      </mat-slide-toggle>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-4">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <!-- Accounts Table -->
  <div class="ed-block-standard" *ngIf="!loading && activeTab === 'accounts'">
    <table mat-table [dataSource]="accounts" class="w-100">
      
      <!-- Name Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Nome Conto</th>
        <td mat-cell *matCellDef="let row">
          <div class="account-name">
            <div class="color-dot" *ngIf="row.color" [style.background-color]="row.color"></div>
            <strong>{{ row.name }}</strong>
          </div>
          <div class="description-small" *ngIf="row.description">{{ row.description }}</div>
        </td>
      </ng-container>

      <!-- Bank Column -->
      <ng-container matColumnDef="bank">
        <th mat-header-cell *matHeaderCellDef>Banca</th>
        <td mat-cell *matCellDef="let row">{{ row.bank?.name || '-' }}</td>
      </ng-container>

      <!-- Type Column -->
      <ng-container matColumnDef="type">
        <th mat-header-cell *matHeaderCellDef>Tipo</th>
        <td mat-cell *matCellDef="let row">
          <span class="type-badge">{{ getAccountTypeLabel(row.account_type) }}</span>
        </td>
      </ng-container>

      <!-- IBAN Column -->
      <ng-container matColumnDef="iban">
        <th mat-header-cell *matHeaderCellDef>IBAN</th>
        <td mat-cell *matCellDef="let row">
          <code class="iban-code">{{ formatIban(row.iban) }}</code>
        </td>
      </ng-container>

      <!-- Balance Column -->
      <ng-container matColumnDef="balance">
        <th mat-header-cell *matHeaderCellDef>Saldo</th>
        <td mat-cell *matCellDef="let row">
          <span class="balance" [ngClass]="(row.current_balance || row.initial_balance) >= 0 ? 'positive' : 'negative'">
            {{ formatCurrency(row.current_balance ?? row.initial_balance) }}
          </span>
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Stato</th>
        <td mat-cell *matCellDef="let row">
          <span class="status-badge" [ngClass]="row.is_active ? 'status-active' : 'status-inactive'">
            {{ row.is_active ? 'Attivo' : 'Inattivo' }}
          </span>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let row">
          <button mat-icon-button [matMenuTriggerFor]="menu" matTooltip="Azioni">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="editAccount(row.id)">
              <mat-icon>edit</mat-icon>
              <span>Modifica</span>
            </button>
            <button mat-menu-item (click)="deleteAccount(row)" class="text-danger">
              <mat-icon color="warn">delete</mat-icon>
              <span>Elimina</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="accountColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: accountColumns;" [class.inactive-row]="!row.is_active"></tr>
    </table>

    <!-- Empty state -->
    <div *ngIf="accounts.length === 0" class="text-center py-4">
      <mat-icon class="empty-icon">account_balance_wallet</mat-icon>
      <p>Nessun conto trovato</p>
      <button mat-raised-button class="primary-button" (click)="addAccount()">
        Crea il primo conto
      </button>
    </div>
  </div>

  <!-- Banks Table -->
  <div class="ed-block-standard" *ngIf="!loading && activeTab === 'banks'">
    <table mat-table [dataSource]="banks" class="w-100">
      
      <!-- Name Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Nome Banca</th>
        <td mat-cell *matCellDef="let row">
          <strong>{{ row.name }}</strong>
        </td>
      </ng-container>

      <!-- ABI Column -->
      <ng-container matColumnDef="abi_code">
        <th mat-header-cell *matHeaderCellDef>Codice ABI</th>
        <td mat-cell *matCellDef="let row">{{ row.abi_code || '-' }}</td>
      </ng-container>

      <!-- SWIFT Column -->
      <ng-container matColumnDef="swift_code">
        <th mat-header-cell *matHeaderCellDef>Codice SWIFT</th>
        <td mat-cell *matCellDef="let row">{{ row.swift_code || '-' }}</td>
      </ng-container>

      <!-- Accounts Count Column -->
      <ng-container matColumnDef="accounts_count">
        <th mat-header-cell *matHeaderCellDef>Conti</th>
        <td mat-cell *matCellDef="let row">{{ row.accounts_count || 0 }}</td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Stato</th>
        <td mat-cell *matCellDef="let row">
          <span class="status-badge" [ngClass]="row.is_active ? 'status-active' : 'status-inactive'">
            {{ row.is_active ? 'Attiva' : 'Inattiva' }}
          </span>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let row">
          <button mat-icon-button [matMenuTriggerFor]="menu" matTooltip="Azioni">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="editBank(row.id)">
              <mat-icon>edit</mat-icon>
              <span>Modifica</span>
            </button>
            <button mat-menu-item (click)="deleteBank(row)" class="text-danger">
              <mat-icon color="warn">delete</mat-icon>
              <span>Elimina</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="bankColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: bankColumns;" [class.inactive-row]="!row.is_active"></tr>
    </table>

    <!-- Empty state -->
    <div *ngIf="banks.length === 0" class="text-center py-4">
      <mat-icon class="empty-icon">account_balance</mat-icon>
      <p>Nessuna banca trovata</p>
      <button mat-raised-button class="primary-button" (click)="addBank()">
        Aggiungi la prima banca
      </button>
    </div>
  </div>
</div>
