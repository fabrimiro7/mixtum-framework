<div class="container-fluid">
  <!-- Header -->
  <div class="row align-items-center mb-4">
    <div class="col">
      <h1>Movimenti Ricorrenti</h1>
    </div>
    <div class="col-md-auto">
      <button mat-raised-button class="primary-button-light me-2" (click)="navigateTo('/finance')">
        <mat-icon fontIcon="arrow_back"></mat-icon>
        <span>MOVIMENTI</span>
      </button>
      <button mat-raised-button class="primary-button" (click)="navigateTo('/finance/recurring/add')">
        <mat-icon fontIcon="add"></mat-icon>
        <span>NUOVA REGOLA</span>
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="ed-block-standard mb-4">
    <div class="grid grid-cols-1 gap-4 md:grid-cols-2">
      <div class="tw-field">
        <label class="tw-label">Tipo</label>
        <app-tw-select
          [(ngModel)]="filterType"
          (selectionChange)="onFilterChange()"
          [items]="[{ value: null, label: 'Tutti' }, { value: 'income', label: 'Entrate' }, { value: 'expense', label: 'Uscite' }]"
          bindValue="value"
          bindLabel="label"
        ></app-tw-select>
      </div>
      <div class="tw-field">
        <mat-slide-toggle [(ngModel)]="showInactive" (change)="onFilterChange()">
          Mostra inattive
        </mat-slide-toggle>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="text-center py-4">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <!-- Table -->
  <div class="ed-block-standard" *ngIf="!loading">
    <table mat-table [dataSource]="rules" class="w-100">
      
      <!-- Name Column -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef>Nome</th>
        <td mat-cell *matCellDef="let row">
          <strong>{{ row.name }}</strong>
          <div class="description-small">{{ row.description }}</div>
        </td>
      </ng-container>

      <!-- Category Column -->
      <ng-container matColumnDef="category">
        <th mat-header-cell *matHeaderCellDef>Categoria</th>
        <td mat-cell *matCellDef="let row">
          <span class="category-badge" [style.background-color]="row.category?.color + '20'" [style.color]="row.category?.color">
            {{ row.category?.name || '-' }}
          </span>
        </td>
      </ng-container>

      <!-- Account Column -->
      <ng-container matColumnDef="account">
        <th mat-header-cell *matHeaderCellDef>Conto</th>
        <td mat-cell *matCellDef="let row">{{ row.account?.name || '-' }}</td>
      </ng-container>

      <!-- Type Column -->
      <ng-container matColumnDef="type">
        <th mat-header-cell *matHeaderCellDef>Tipo</th>
        <td mat-cell *matCellDef="let row">
          <span class="type-badge" [ngClass]="getTypeClass(row.transaction_type)">
            {{ getTypeLabel(row.transaction_type) }}
          </span>
        </td>
      </ng-container>

      <!-- Amount Column -->
      <ng-container matColumnDef="amount">
        <th mat-header-cell *matHeaderCellDef>Importo</th>
        <td mat-cell *matCellDef="let row">
          <span [ngClass]="row.transaction_type === 'income' ? 'amount-income' : 'amount-expense'">
            {{ row.transaction_type === 'income' ? '+' : '-' }}{{ formatCurrency(row.gross_amount) }}
          </span>
        </td>
      </ng-container>

      <!-- Frequency Column -->
      <ng-container matColumnDef="frequency">
        <th mat-header-cell *matHeaderCellDef>Frequenza</th>
        <td mat-cell *matCellDef="let row">
          {{ getFrequencyLabel(row.frequency) }}
          <span class="day-info" *ngIf="row.day_of_month">
            (giorno {{ row.day_of_month }})
          </span>
        </td>
      </ng-container>

      <!-- Next Occurrence Column -->
      <ng-container matColumnDef="next_occurrence">
        <th mat-header-cell *matHeaderCellDef>Prossimo</th>
        <td mat-cell *matCellDef="let row">{{ formatDate(row.next_occurrence) }}</td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Stato</th>
        <td mat-cell *matCellDef="let row">
          <span class="status-badge" [ngClass]="row.is_active ? 'status-active' : 'status-inactive'">
            {{ row.is_active ? 'Attiva' : 'Inattiva' }}
          </span>
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let row">
          <button mat-icon-button [matMenuTriggerFor]="menu" matTooltip="Azioni">
            <mat-icon>more_vert</mat-icon>
          </button>
          <mat-menu #menu="matMenu">
            <button mat-menu-item (click)="editRule(row.id)">
              <mat-icon>edit</mat-icon>
              <span>Modifica</span>
            </button>
            <button mat-menu-item (click)="generateNow(row)" *ngIf="row.is_active">
              <mat-icon>play_arrow</mat-icon>
              <span>Genera Ora</span>
            </button>
            <button mat-menu-item (click)="toggleActive(row)">
              <mat-icon>{{ row.is_active ? 'pause' : 'play_arrow' }}</mat-icon>
              <span>{{ row.is_active ? 'Disattiva' : 'Attiva' }}</span>
            </button>
            <button mat-menu-item (click)="deleteRule(row)" class="text-danger">
              <mat-icon color="warn">delete</mat-icon>
              <span>Elimina</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns;" [class.inactive-row]="!row.is_active"></tr>
    </table>

    <!-- Empty state -->
    <div *ngIf="rules.length === 0" class="text-center py-4">
      <mat-icon class="empty-icon">repeat</mat-icon>
      <p>Nessuna regola ricorrente trovata</p>
      <button mat-raised-button class="primary-button" (click)="navigateTo('/finance/recurring/add')">
        Crea la prima regola
      </button>
    </div>
  </div>
</div>
